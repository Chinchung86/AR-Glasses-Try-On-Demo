<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Ensure mobile devices scale the page correctly -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Glasses AR Try-On</title>

    <!-- Three.js & GLTFLoader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <!-- MediaPipe FaceMesh & Camera Utils -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <!-- QRious for QR Code generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }
      .container {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      /* Desktop: side-by-side layout */
      @media (min-width: 768px) {
        .container {
          flex-direction: row;
        }
        #viewer {
          width: 50vw;
          height: 100vh;
          background: #f0f0f0;
          position: relative;
        }
        #qr-container {
          width: 50vw;
          height: 100vh;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
        }
        #tryOnBtn {
          position: absolute;
          bottom: 20px;
          right: 20px;
        }
      }
      /* Mobile: vertical stacking */
      @media (max-width: 767px) {
        #viewer {
          width: 100vw;
          height: 50vh;
          background: #f0f0f0;
          position: relative;
        }
        #qr-container {
          width: 100vw;
          height: 50vh;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
        }
        #tryOnBtn {
          position: absolute;
          bottom: 20px;
          right: 20px;
        }
      }
      /* Common styles */
      #tryOnBtn {
        padding: 10px 20px;
        background-color: #007aff;
        border: none;
        border-radius: 5px;
        color: #fff;
        cursor: pointer;
        font-size: 16px;
        z-index: 20;
      }
      /* AR overlay for the try-on experience */
      #ar-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #333;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 30;
        flex-direction: column;
      }
      /* Display the video feed during AR try-on */
      #ar-video {
        width: 100%;
        max-width: 640px;
        height: auto;
        border: 2px solid #fff;
        border-radius: 5px;
        background: #000;
        display: block; /* Change from none to block so it's visible */
      }
      #closeAR {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #FF3B30;
        border: none;
        border-radius: 5px;
        color: #fff;
        cursor: pointer;
        font-size: 16px;
        z-index: 31;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Three.js viewer -->
      <div id="viewer"></div>
      
      <!-- QR Code section -->
      <div id="qr-container">
        <p>Scan this QR code on your mobile device for AR:</p>
        <canvas id="qr-code"></canvas>
      </div>
      
      <!-- Try-On Button -->
      <button id="tryOnBtn">Try On Glasses</button>
    </div>
    
    <!-- AR overlay for the try-on experience -->
    <div id="ar-overlay">
      <!-- The video feed for MediaPipe face tracking -->
      <video id="ar-video" autoplay playsinline></video>
      <!-- Close AR button -->
      <button id="closeAR">Close AR</button>
    </div>

    <script>
      /* =============================
         THREE.JS 3D MODEL VIEWER
         ============================= */
      let scene, camera, renderer, glassesModel;

      function initThree() {
        const viewer = document.getElementById('viewer');
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, viewer.clientWidth / viewer.clientHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 3);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(viewer.clientWidth, viewer.clientHeight);
        viewer.appendChild(renderer.domElement);

        // Ambient light for even lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);
        
        // Load the glasses model â€“ ensure glasses.glb is in the repository root
        const loader = new THREE.GLTFLoader();
        loader.load(
          'glasses.glb',
          (gltf) => {
            glassesModel = gltf.scene;
            glassesModel.scale.set(0.5, 0.5, 0.5);
            glassesModel.position.set(0, 1.6, 0);
            scene.add(glassesModel);
          },
          undefined,
          (error) => {
            console.error('Error loading model:', error);
          }
        );
        animate();
      }

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }

      /* =============================
         QR Code Generation (QRious)
         ============================= */
      function generateQRCode() {
        const qrElement = document.getElementById('qr-code');
        new QRious({
          element: qrElement,
          value: window.location.href,
          size: 200
        });
      }

      /* =============================
         MEDIA PIPELINE: FACE MESH FOR AR TRY-ON
         ============================= */
      let faceMesh, arVideoElement, mpCamera;

      function initFaceMesh() {
        arVideoElement = document.getElementById('ar-video');
        faceMesh = new FaceMesh.FaceMesh({
          locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });
        faceMesh.setOptions({
          maxNumFaces: 1,
          refineLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });
        faceMesh.onResults(onFaceResults);

        // Use MediaPipe Camera utils to capture video
        mpCamera = new CameraUtils.Camera(arVideoElement, {
          onFrame: async () => {
            await faceMesh.send({ image: arVideoElement });
          },
          width: 640,
          height: 480
        });
        mpCamera.start().catch((err) => console.error("Camera start error:", err));
      }

      function onFaceResults(results) {
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && glassesModel) {
          const landmarks = results.multiFaceLandmarks[0];
          // For instance, use landmarks 33 (left eye inner) and 263 (right eye inner) for midpoint
          const left = landmarks[33];
          const right = landmarks[263];
          const midX = (left.x + right.x) / 2;
          const midY = (left.y + right.y) / 2;
          const offsetX = (midX - 0.5) * 2; // roughly -1 to 1
          const offsetY = -(midY - 0.5) * 2; // invert Y axis

          // Update glasses position (adjust scale multipliers as needed)
          glassesModel.position.x = offsetX;
          glassesModel.position.y = 1.6 + offsetY * 0.2;
        }
      }

      /* =============================
         AR TRY-ON BUTTON & OVERLAY HANDLING
         ============================= */
      const tryOnBtn = document.getElementById('tryOnBtn');
      const arOverlay = document.getElementById('ar-overlay');
      const closeARBtn = document.getElementById('closeAR');

      tryOnBtn.addEventListener('click', () => {
        arOverlay.style.display = 'flex';
        // Hide other parts of the page
        document.getElementById('viewer').style.display = 'none';
        document.getElementById('qr-container').style.display = 'none';
        // Initialize MediaPipe if not already done
        if (!faceMesh) {
          initFaceMesh();
        }
      });

      closeARBtn.addEventListener('click', () => {
        arOverlay.style.display = 'none';
        document.getElementById('viewer').style.display = 'block';
        document.getElementById('qr-container').style.display = 'flex';
        // Optionally stop the camera feed if desired
        if (mpCamera) {
          mpCamera.stop();
        }
      });

      /* =============================
         Initialize on Page Load
         ============================= */
      window.addEventListener('load', () => {
        initThree();
        generateQRCode();
      });
    </script>
  </body>
</html>
