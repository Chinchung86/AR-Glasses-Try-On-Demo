<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Glasses Try-On Demo</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- Mediapipe FaceMesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <!-- Qrios QR Code Generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrios@1.0.2/dist/qrios.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #container { display: flex; flex-direction: column; align-items: center; padding: 1rem; }
    #viewer { width: 100%; max-width: 600px; height: 400px; border: 1px solid #ccc; }
    #controls { margin-top: 1rem; }
    #qr { margin-top: 1rem; }
    button { padding: .5rem 1rem; font-size: 1rem; }
  </style>
</head>
<body>
  <div id="container">
    <div id="viewer"></div>
    <div id="controls">
      <button id="start-ar">Try On Glasses</button>
    </div>
    <canvas id="qr"></canvas>
  </div>

  <script>
    const MODEL_URL = 'https://raw.githubusercontent.com/Chinchung86/AR-Glasses-Try-On-Demo/main/glasses.glb';
    const viewerEl = document.querySelector('#viewer');
    const startBtn = document.querySelector('#start-ar');
    const qrCanvas = document.querySelector('#qr');
    const pageUrl = window.location.href;
    // Generate QR code for mobile link
    Qrios.render({
      target: qrCanvas,
      text: pageUrl,
      width: 200,
      height: 200
    });
    // Inject A-Frame scene
    viewerEl.innerHTML = `
      <a-scene embedded vr-mode-ui="enabled: false" renderer="colorManagement: true;" arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-entity id="glasses" gltf-model="${MODEL_URL}" visible="false"></a-entity>
        <a-entity camera></a-entity>
      </a-scene>
    `;

    // Load Mediapipe FaceMesh
    const faceMesh = new FaceMesh({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
    faceMesh.onResults(onResults);

    let videoInput, camera;
    function initCamera() {
      videoInput = document.createElement('video');
      videoInput.style.display = 'none';
      document.body.appendChild(videoInput);
      camera = new Camera(videoInput, {onFrame: async () => await faceMesh.send({image: videoInput}), width:640, height:480});
    }

    function onResults(results) {
      const glasses = document.querySelector('#glasses');
      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const lm = results.multiFaceLandmarks[0];
        // Compute position & rotation from landmarks (e.g., between eyes)
        const left = lm[33];
        const right = lm[263];
        const midX = (left.x + right.x)/2;
        const midY = (left.y + right.y)/2;
        glasses.setAttribute('position', `${(midX-0.5)*2} ${(0.5-midY)*2} -1`);
        // Simple scale based on eye distance
        const dist = Math.hypot(right.x-left.x, right.y-left.y);
        glasses.setAttribute('scale', `${dist*5} ${dist*5} ${dist*5}`);
        glasses.setAttribute('visible','true');
      } else {
        document.querySelector('#glasses').setAttribute('visible','false');
      }
    }

    startBtn.addEventListener('click', () => {
      initCamera();
      camera.start();
    });
  </script>
</body>
</html>
